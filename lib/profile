bind -qa $home/bin/rc /bin
bind -qa $home/bin/$cputype /bin
bind -qa $home/lib/bin /bin
bind -qa $home/lib/bin/git /bin/git/
fontlib=/lib/font/bit
font=$fontlib/pragmata/pragmatta.14.font

mailserver=fastmail.com
mailuser=telecom@sansfontieres.com
maildirs=(Sent 9 Bookmarks Feed Miscs-Lists OpenBSD sr.ht-discuss Todo Archive)

fn open_mailboxes {
	upas/fs -f /imaps/imap.$mailserver/$mailuser
	for(i in $maildirs){
		upas/fs -f /imaps/imap.$mailserver/$mailuser/$i
	}
}

fn setup_secstore{ # see /cfg/$sysname/termrc
	secstore=tcp!127.0.0.1!5356
	auth/secstored -s $secstore
	ipso -l
}

fn wifi{
	grep node '#l1'/ether1/ifstats
	echo -n 'essid='
	essid=`{dd -bs 64 -count 1 >[2]/dev/null}
	bind -a '#l1' /net
	aux/wpa -s $essid -p /net/ether1
	ip/ipconfig ether /net/ether1
}

switch($service){
case terminal
	webcookies
	webfs
	setup_secstore
	wifi
	plumber
	echo -n accelerated > '#m/mousectl'
	echo -n 'res 3' > '#m/mousectl'
	prompt=('; ' '	')
	fn term%{ $* }
	rio -i riostart
case cpu
	bind /mnt/term/dev/cons /dev/cons
	bind -q /mnt/term/dev/consctl /dev/consctl
	>[2] /dev/null {
		cp /dev/sysname /mnt/term/dev/label
		if(wsys=`{cat /mnt/term/env/wsys} && ~ $#wsys 1) {
			wsys=/mnt/term^$wsys
		}
		if not {
			wsys=()
		}
	} 
	bind -a /mnt/term/dev /dev
	prompt=('cpu% ' '	')
	fn cpu%{ $* }
	if(! test -e /mnt/term/dev/wsys){
		# call from drawterm
		if(test -e /mnt/term/dev/secstore){
			auth/factotum -n
			read -m /mnt/term/dev/secstore >/mnt/factotum/ctl
			echo >/mnt/term/dev/secstore
		}
		if not
			auth/factotum
		webcookies
		webfs
		plumber
		rio
	}
case con
	prompt=('cpu% ' '	')
}

# Some aliases
fn vis{sam $*}
fn sma{sam $*}
